-- Migrate to Version 2 
ALTER VIEW `tickets view`  AS SELECT `tickets`.`serial` AS `serial`, `tickets`.`description` AS `description`, `tickets`.`currency` AS `currency`, `tickets`.`price` AS `price`, `tickets`.`carnets` AS `carnets`, `tickets`.`expired` AS `expired`, `tickets info`.`first use` AS `first use`, `tickets info`.`last use` AS `last use`, `tickets info`.`carnets used` AS `carnets used`, `tickets info`.`segments travelled` AS `segments travelled`, `tickets info`.`distance travelled` AS `distance travelled`, `tickets`.`price`/ `tickets`.`carnets` * `tickets info`.`carnets used` AS `price used`, `tickets`.`price`/ `tickets`.`carnets` * `tickets info`.`carnets used` / `tickets info`.`distance travelled` AS `price per km` FROM (`tickets` join (select `tickets`.`serial` AS `_serial`,(select min(`journeys`.`boarding time stamp`) from (`ticket uses` join `journeys` on(`ticket uses`.`journey serial` = `journeys`.`serial`)) where `ticket uses`.`ticket serial` = `tickets`.`serial`) AS `first use`,(select max(`journeys`.`alighting time stamp`) from (`ticket uses` join `journeys` on(`ticket uses`.`journey serial` = `journeys`.`serial`)) where `ticket uses`.`ticket serial` = `tickets`.`serial`) AS `last use`,(select count(distinct `ticket uses`.`carnet sequence`) from `ticket uses` where `ticket uses`.`ticket serial` = `tickets`.`serial`) AS `carnets used`,(select count(distinct `ticket uses`.`journey serial`) from `ticket uses` where `ticket uses`.`ticket serial` = `tickets`.`serial`) AS `segments travelled`,(select ifnull(sum(ifnull(`ticket uses`.`distance covered`,`journeys`.`distance`)),0) from (`ticket uses` join `journeys` on(`ticket uses`.`journey serial` = `journeys`.`serial`)) where `ticket uses`.`ticket serial` = `tickets`.`serial`) AS `distance travelled` from `tickets`) `tickets info` on(`tickets`.`serial` = `tickets info`.`_serial`)) ORDER BY `tickets info`.`last use` desc  ;
